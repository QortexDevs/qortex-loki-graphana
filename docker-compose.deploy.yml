version: '3.8'

# Docker Compose file for deploying the built monitoring stack image
# This runs the built image which internally uses docker-compose to start services

services:
  monitoring-stack:
    image: qortex-loki-grafana:latest
    container_name: monitoring-stack
    ports:
      - "3000:3000"  # Grafana
      - "3100:3100"  # Loki
      - "9080:9080"  # Promtail
    volumes:
      # Mount Docker socket - required for:
      # 1. The container to run docker-compose (to start services)
      # 2. Promtail to discover and monitor containers
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount Docker containers directory for Promtail log access
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Persistent volumes for data (created by internal docker-compose)
      - monitoring-loki-data:/loki
      - monitoring-grafana-data:/var/lib/grafana
    restart: unless-stopped
    # Note: The container runs docker-compose internally, which starts
    # the actual Loki, Grafana, and Promtail containers on the host

volumes:
  monitoring-loki-data:
  monitoring-grafana-data:
